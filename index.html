<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taskline ‚Äî Your Personal Todo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a2e;
    --paper: #f5f0e8;
    --cream: #ede7d9;
    --accent: #c0392b;
    --accent-light: #e74c3c;
    --muted: #8a8070;
    --border: #d4c9b8;
    --card: #faf7f2;
    --shadow: 0 2px 20px rgba(26,26,46,0.08);
    --tag-bg: #eef4ff;
    --tag-color: #2c5fad;
    --tag-border: #c2d5f7;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    font-size: 15px;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23noise)' opacity='0.035'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
  #auth-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
    position: relative;
    z-index: 1;
  }

  .auth-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 3rem 3.5rem;
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow), 6px 6px 0 var(--cream);
  }

  .brand { margin-bottom: 2.5rem; }
  .brand h1 { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 700; letter-spacing: -0.5px; line-height: 1; }
  .brand span { color: var(--accent); }
  .brand p { color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem; font-weight: 300; }

  .tab-row { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.8rem; }
  .tab-btn {
    background: none; border: none;
    padding: 0.6rem 1.2rem 0.75rem;
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 500;
    color: var(--muted); cursor: pointer;
    border-bottom: 2px solid transparent; margin-bottom: -1px;
    letter-spacing: 0.04em; text-transform: uppercase;
    transition: color 0.2s, border-color 0.2s;
  }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  .form-group { margin-bottom: 1.2rem; }
  label { display: block; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); margin-bottom: 0.4rem; font-weight: 500; }

  input[type="email"], input[type="password"], input[type="text"] {
    width: 100%; background: var(--paper); border: 1px solid var(--border); border-radius: 2px;
    padding: 0.75rem 1rem; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--ink);
    outline: none; transition: border-color 0.2s;
  }
  input:focus { border-color: var(--accent); }

  .btn-primary {
    width: 100%; background: var(--accent); color: #fff; border: none;
    padding: 0.85rem 1.5rem; font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem; font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase;
    cursor: pointer; border-radius: 2px; margin-top: 0.5rem; transition: background 0.2s, transform 0.1s;
  }
  .btn-primary:hover { background: var(--accent-light); }
  .btn-primary:active { transform: translateY(1px); }

  .divider { display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; color: var(--muted); font-size: 0.8rem; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .btn-google {
    width: 100%; background: #fff; border: 1px solid var(--border); padding: 0.8rem 1.5rem;
    border-radius: 2px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 500;
    color: var(--ink); cursor: pointer; display: flex; align-items: center; justify-content: center;
    gap: 0.75rem; transition: background 0.2s, border-color 0.2s;
  }
  .btn-google:hover { background: var(--cream); border-color: var(--muted); }

  .error-msg {
    background: #fdf0ef; border-left: 3px solid var(--accent);
    padding: 0.7rem 1rem; font-size: 0.85rem; color: var(--accent);
    margin-bottom: 1rem; border-radius: 0 2px 2px 0; display: none;
  }

  /* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
  #app-screen { display: none; min-height: 100vh; position: relative; z-index: 1; }

  header {
    background: var(--card); border-bottom: 1px solid var(--border);
    padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 10;
  }
  .header-brand { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; }
  .header-brand span { color: var(--accent); }
  .user-info { display: flex; align-items: center; gap: 1rem; }
  .user-avatar {
    width: 34px; height: 34px; background: var(--cream); border: 1px solid var(--border);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 0.85rem; font-weight: 500; color: var(--muted); overflow: hidden;
  }
  .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
  .user-email { font-size: 0.82rem; color: var(--muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-signout {
    background: none; border: 1px solid var(--border); padding: 0.4rem 0.9rem; border-radius: 2px;
    font-family: 'DM Sans', sans-serif; font-size: 0.8rem; color: var(--muted);
    cursor: pointer; letter-spacing: 0.04em; transition: all 0.2s;
  }
  .btn-signout:hover { border-color: var(--accent); color: var(--accent); }

  main { max-width: 680px; margin: 3rem auto; padding: 0 1.5rem; }
  .page-title { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 700; margin-bottom: 0.4rem; }
  .page-subtitle { color: var(--muted); font-size: 0.88rem; margin-bottom: 2rem; font-weight: 300; }

  /* Add task */
  .add-task-card {
    background: var(--card); border: 1px solid var(--border); border-radius: 2px;
    padding: 1.2rem 1.4rem; margin-bottom: 1.5rem; box-shadow: var(--shadow);
  }
  .add-task-row { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; }
  .add-task-row input { flex: 1; }
  .btn-add {
    background: var(--accent); color: #fff; border: none; padding: 0.75rem 1.4rem;
    border-radius: 2px; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; font-weight: 500;
    cursor: pointer; white-space: nowrap; transition: background 0.2s, transform 0.1s;
  }
  .btn-add:hover { background: var(--accent-light); }
  .btn-add:active { transform: translateY(1px); }

  /* Tag chip input */
  .tag-input-row {
    display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;
    padding: 0.5rem 0.75rem; background: var(--paper); border: 1px solid var(--border);
    border-radius: 2px; min-height: 42px; cursor: text; transition: border-color 0.2s;
  }
  .tag-input-row:focus-within { border-color: var(--accent); }

  .tag-chip {
    display: inline-flex; align-items: center; gap: 0.3rem;
    background: var(--tag-bg); color: var(--tag-color); border: 1px solid var(--tag-border);
    border-radius: 20px; padding: 0.15rem 0.6rem 0.15rem 0.5rem; font-size: 0.78rem; font-weight: 500;
  }
  .tag-chip .remove-tag { cursor: pointer; opacity: 0.6; font-size: 0.9rem; line-height: 1; padding: 0 0.1rem; transition: opacity 0.15s; }
  .tag-chip .remove-tag:hover { opacity: 1; }

  .tag-text-input {
    border: none !important; outline: none !important; background: transparent !important;
    padding: 0 !important; min-width: 160px; flex: 1; font-size: 0.88rem !important;
    font-family: 'DM Sans', sans-serif !important; color: var(--ink) !important;
  }
  .tag-hint { font-size: 0.75rem; color: var(--muted); margin-top: 0.4rem; }

  /* Filters */
  .filter-row { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
  .filter-btn {
    background: none; border: 1px solid var(--border); padding: 0.35rem 0.9rem; border-radius: 20px;
    font-family: 'DM Sans', sans-serif; font-size: 0.8rem; color: var(--muted);
    cursor: pointer; transition: all 0.2s;
  }
  .filter-btn.active { background: var(--ink); border-color: var(--ink); color: #fff; }

  /* Tasks */
  #tasks-list { display: flex; flex-direction: column; gap: 0.6rem; }

  .task-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 2px;
    padding: 1rem 1.2rem; animation: slideIn 0.25s ease; transition: opacity 0.2s, box-shadow 0.2s;
  }
  .task-item:hover { box-shadow: var(--shadow); }
  .task-item.done { opacity: 0.55; }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .task-main-row { display: flex; align-items: flex-start; gap: 1rem; }

  .task-check {
    width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%;
    cursor: pointer; flex-shrink: 0; margin-top: 2px;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s;
  }
  .task-check:hover { border-color: var(--accent); }
  .task-item.done .task-check { background: var(--accent); border-color: var(--accent); }
  .task-item.done .task-check::after { content: '‚úì'; color: #fff; font-size: 11px; font-weight: 700; }

  .task-body { flex: 1; min-width: 0; }
  .task-text { font-size: 0.95rem; line-height: 1.5; word-break: break-word; }
  .task-item.done .task-text { text-decoration: line-through; color: var(--muted); }

  .task-edit-input {
    width: 100%; background: var(--paper); border: 1px solid var(--accent);
    border-radius: 2px; padding: 0.4rem 0.6rem;
    font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--ink); outline: none;
  }

  .task-meta { display: flex; align-items: center; gap: 0.6rem; margin-top: 0.5rem; flex-wrap: wrap; }
  .task-date { font-size: 0.75rem; color: var(--muted); }

  .task-tag {
    display: inline-flex; align-items: center; gap: 0.25rem;
    background: var(--tag-bg); color: var(--tag-color); border: 1px solid var(--tag-border);
    border-radius: 20px; padding: 0.1rem 0.55rem; font-size: 0.74rem; font-weight: 500;
  }
  .task-tag::before { content: '@'; opacity: 0.6; }

  .task-actions { display: flex; gap: 0.3rem; flex-shrink: 0; margin-top: 1px; }
  .task-btn {
    background: none; border: none; color: var(--muted); font-size: 0.8rem;
    cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 2px;
    transition: color 0.15s, background 0.15s; font-family: 'DM Sans', sans-serif; white-space: nowrap;
  }
  .task-btn:hover { color: var(--ink); background: var(--cream); }
  .task-btn.delete:hover { color: var(--accent); background: #fdf0ef; }

  .edit-save-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .btn-save {
    background: var(--accent); color: #fff; border: none; padding: 0.35rem 0.9rem; border-radius: 2px;
    font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: background 0.2s;
  }
  .btn-save:hover { background: var(--accent-light); }
  .btn-cancel {
    background: none; border: 1px solid var(--border); padding: 0.35rem 0.9rem; border-radius: 2px;
    font-family: 'DM Sans', sans-serif; font-size: 0.8rem; color: var(--muted); cursor: pointer; transition: all 0.2s;
  }
  .btn-cancel:hover { border-color: var(--muted); color: var(--ink); }

  .edit-tags-row {
    display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center;
    padding: 0.4rem 0.6rem; background: var(--paper); border: 1px solid var(--border);
    border-radius: 2px; min-height: 36px; margin-top: 0.5rem; cursor: text; transition: border-color 0.2s;
  }
  .edit-tags-row:focus-within { border-color: var(--accent); }

  .empty-state { text-align: center; padding: 4rem 2rem; color: var(--muted); }
  .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; display: block; }
  .empty-state p { font-size: 0.9rem; font-weight: 300; }

  .stats-bar {
    display: flex; gap: 2rem; padding: 1.2rem 0;
    border-top: 1px solid var(--border); margin-top: 1.5rem;
    font-size: 0.82rem; color: var(--muted);
  }
  .stat strong { color: var(--ink); font-size: 1.1rem; display: block; font-family: 'Playfair Display', serif; }
  .loading { display: flex; justify-content: center; padding: 3rem; color: var(--muted); font-size: 0.9rem; }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="brand">
      <h1>Task<span>line</span></h1>
      <p>Your personal task manager ‚Äî sign in to begin.</p>
    </div>
    <div class="tab-row">
      <button class="tab-btn active" onclick="switchTab('login')">Sign in</button>
      <button class="tab-btn" onclick="switchTab('register')">Register</button>
    </div>
    <div id="auth-error" class="error-msg"></div>

    <div id="login-form">
      <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="you@example.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="btn-primary" onclick="handleLogin()">Sign in</button>
      <div class="divider">or</div>
      <button class="btn-google" onclick="handleGoogle()">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Continue with Google
      </button>
    </div>

    <div id="register-form" style="display:none">
      <div class="form-group"><label>Email</label><input type="email" id="reg-email" placeholder="you@example.com"></div>
      <div class="form-group"><label>Password</label><input type="password" id="reg-password" placeholder="Min. 6 characters"></div>
      <button class="btn-primary" onclick="handleRegister()">Create account</button>
      <div class="divider">or</div>
      <button class="btn-google" onclick="handleGoogle()">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Continue with Google
      </button>
    </div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="app-screen">
  <header>
    <div class="header-brand">Task<span>line</span></div>
    <div class="user-info">
      <div class="user-avatar" id="user-avatar"></div>
      <span class="user-email" id="user-email-display"></span>
      <button class="btn-signout" onclick="handleSignOut()">Sign out</button>
    </div>
  </header>

  <main>
    <h2 class="page-title" id="greeting">Good morning</h2>
    <p class="page-subtitle">Here's what's on your list today.</p>

    <div class="add-task-card">
      <div class="add-task-row">
        <input type="text" id="new-task-input" placeholder="Add a new task‚Ä¶" maxlength="300">
        <button class="btn-add" onclick="addTask()">+ Add</button>
      </div>
      <div class="tag-input-row" id="new-tag-container" onclick="document.getElementById('new-tag-input').focus()">
        <input type="text" class="tag-text-input" id="new-tag-input" placeholder="Tag people by email (press Enter or comma)‚Ä¶">
      </div>
      <p class="tag-hint">Type an email and press <strong>Enter</strong> or <strong>,</strong> to add a tag</p>
    </div>

    <div class="filter-row">
      <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
      <button class="filter-btn" onclick="setFilter('active', this)">Active</button>
      <button class="filter-btn" onclick="setFilter('done', this)">Done</button>
    </div>

    <div id="tasks-list"><div class="loading">Loading your tasks‚Ä¶</div></div>

    <div class="stats-bar" id="stats-bar" style="display:none">
      <div class="stat"><strong id="stat-total">0</strong>Total</div>
      <div class="stat"><strong id="stat-done">0</strong>Completed</div>
      <div class="stat"><strong id="stat-active">0</strong>Remaining</div>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import {
    getFirestore, collection, addDoc, query, where, orderBy,
    onSnapshot, updateDoc, deleteDoc, doc, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCG6MpOYSF_NRhUj6UER40yWILubNQI5EE",
    authDomain: "todo-67067.firebaseapp.com",
    projectId: "todo-67067",
    storageBucket: "todo-67067.firebasestorage.app",
    messagingSenderId: "731409843570",
    appId: "1:731409843570:web:1786fd1e738086871ac9eb",
    measurementId: "G-QXVJD5HW49"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  let currentUser = null;
  let currentFilter = 'all';
  let unsubscribeTasks = null;
  let cachedTasks = [];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  TAG CHIP UTILITIES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function makeChip(email, onRemove) {
    const chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.innerHTML = `${escapeHtml(email)} <span class="remove-tag" title="Remove">√ó</span>`;
    chip.querySelector('.remove-tag').addEventListener('click', e => { e.stopPropagation(); onRemove(); });
    return chip;
  }

  // ‚îÄ‚îÄ‚îÄ "Add Task" tag state ‚îÄ‚îÄ‚îÄ
  let newTaskTags = [];

  function renderNewTags() {
    const container = document.getElementById('new-tag-container');
    const input = document.getElementById('new-tag-input');
    container.querySelectorAll('.tag-chip').forEach(c => c.remove());
    newTaskTags.forEach((email, i) => {
      container.insertBefore(makeChip(email, () => { newTaskTags.splice(i, 1); renderNewTags(); }), input);
    });
  }

  function addNewTag(raw) {
    const email = raw.trim().replace(/,/g, '').toLowerCase();
    if (!email || !email.includes('@') || newTaskTags.includes(email)) return;
    newTaskTags.push(email);
    renderNewTags();
  }

  document.getElementById('new-tag-input').addEventListener('keydown', e => {
    const input = e.target;
    if (e.key === 'Enter' || e.key === ',') {
      e.preventDefault();
      addNewTag(input.value);
      input.value = '';
    } else if (e.key === 'Backspace' && input.value === '' && newTaskTags.length) {
      newTaskTags.pop(); renderNewTags();
    }
  });

  document.getElementById('new-tag-input').addEventListener('blur', e => {
    if (e.target.value.trim()) { addNewTag(e.target.value); e.target.value = ''; }
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  AUTH
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  onAuthStateChanged(auth, user => {
    if (user) { currentUser = user; showApp(user); }
    else { currentUser = null; showAuth(); }
  });

  function showApp(user) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app-screen').style.display = 'block';
    const avatar = document.getElementById('user-avatar');
    avatar.innerHTML = user.photoURL ? `<img src="${user.photoURL}" alt="">` : escapeHtml((user.email || 'U')[0].toUpperCase());
    document.getElementById('user-email-display').textContent = user.displayName || user.email;
    const h = new Date().getHours();
    const g = h < 12 ? 'Good morning' : h < 18 ? 'Good afternoon' : 'Good evening';
    document.getElementById('greeting').textContent = g + (user.displayName ? `, ${user.displayName.split(' ')[0]}` : '');
    loadTasks();
  }

  function showAuth() {
    document.getElementById('app-screen').style.display = 'none';
    document.getElementById('auth-screen').style.display = 'flex';
    if (unsubscribeTasks) { unsubscribeTasks(); unsubscribeTasks = null; }
  }

  window.switchTab = tab => {
    document.getElementById('login-form').style.display = tab === 'login' ? '' : 'none';
    document.getElementById('register-form').style.display = tab === 'register' ? '' : 'none';
    document.querySelectorAll('.tab-btn').forEach(b =>
      b.classList.toggle('active', b.textContent.toLowerCase().includes(tab === 'login' ? 'sign' : 'reg')));
    clearError();
  };

  window.handleLogin = async () => {
    try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value.trim(), document.getElementById('login-password').value); }
    catch (e) { showError(friendlyError(e.code)); }
  };

  window.handleRegister = async () => {
    try { await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value.trim(), document.getElementById('reg-password').value); }
    catch (e) { showError(friendlyError(e.code)); }
  };

  window.handleGoogle = async () => {
    try { await signInWithPopup(auth, googleProvider); }
    catch (e) { showError(friendlyError(e.code)); }
  };

  window.handleSignOut = () => signOut(auth);

  function showError(msg) { const el = document.getElementById('auth-error'); el.textContent = msg; el.style.display = 'block'; }
  function clearError() { document.getElementById('auth-error').style.display = 'none'; }

  function friendlyError(code) {
    return ({
      'auth/user-not-found': 'No account found with that email.',
      'auth/wrong-password': 'Incorrect password.',
      'auth/email-already-in-use': 'Email already in use.',
      'auth/weak-password': 'Password must be at least 6 characters.',
      'auth/invalid-email': 'Please enter a valid email.',
      'auth/popup-closed-by-user': 'Sign-in popup was closed.',
    })[code] || 'Something went wrong. Please try again.';
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  TASKS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function loadTasks() {
    document.getElementById('tasks-list').innerHTML = '<div class="loading">Loading your tasks‚Ä¶</div>';
    const q = query(collection(db, 'tasks'), where('uid', '==', currentUser.uid), orderBy('createdAt', 'desc'));
    unsubscribeTasks = onSnapshot(q, snap => {
      cachedTasks = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderTasks(cachedTasks);
    });
  }

  function renderTasks(tasks) {
    const listEl = document.getElementById('tasks-list');
    const filtered = tasks.filter(t =>
      currentFilter === 'active' ? !t.done : currentFilter === 'done' ? t.done : true
    );

    document.getElementById('stats-bar').style.display = tasks.length ? 'flex' : 'none';
    document.getElementById('stat-total').textContent = tasks.length;
    document.getElementById('stat-done').textContent = tasks.filter(t => t.done).length;
    document.getElementById('stat-active').textContent = tasks.filter(t => !t.done).length;

    if (!filtered.length) {
      listEl.innerHTML = `<div class="empty-state">
        <span class="icon">${currentFilter === 'done' ? 'üéâ' : '‚úèÔ∏è'}</span>
        <p>${currentFilter === 'done' ? 'No completed tasks yet.' : currentFilter === 'active' ? 'All caught up!' : 'Add your first task above.'}</p>
      </div>`;
      return;
    }
    listEl.innerHTML = filtered.map(taskHTML).join('');
  }

  function taskHTML(task) {
    const date = task.createdAt?.toDate();
    const dateStr = date ? date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
    const tags = task.tags || [];
    const tagHTML = tags.map(t => `<span class="task-tag">${escapeHtml(t)}</span>`).join('');
    return `<div class="task-item ${task.done ? 'done' : ''}" id="task-${task.id}">
      <div class="task-main-row">
        <div class="task-check" onclick="toggleTask('${task.id}', ${!!task.done})"></div>
        <div class="task-body">
          <div class="task-text">${escapeHtml(task.text)}</div>
          <div class="task-meta">
            ${dateStr ? `<span class="task-date">${dateStr}</span>` : ''}
            ${tagHTML}
          </div>
        </div>
        <div class="task-actions">
          <button class="task-btn" onclick="startEdit('${task.id}')">‚úé Edit</button>
          <button class="task-btn delete" onclick="deleteTask('${task.id}')">√ó Delete</button>
        </div>
      </div>
    </div>`;
  }

  // ‚îÄ‚îÄ‚îÄ Inline Edit ‚îÄ‚îÄ‚îÄ
  window.startEdit = id => {
    const task = cachedTasks.find(t => t.id === id);
    if (!task) return;

    const item = document.getElementById(`task-${id}`);
    const editTags = [...(task.tags || [])];

    function renderEditChips() {
      const container = document.getElementById(`edit-tags-${id}`);
      const input = document.getElementById(`edit-tag-input-${id}`);
      if (!container || !input) return;
      container.querySelectorAll('.tag-chip').forEach(c => c.remove());
      editTags.forEach((email, i) => {
        container.insertBefore(makeChip(email, () => { editTags.splice(i, 1); renderEditChips(); }), input);
      });
    }

    item.innerHTML = `
      <div class="task-main-row">
        <div class="task-check" style="${task.done ? 'background:var(--accent);border-color:var(--accent)' : ''}">
          ${task.done ? '<span style="color:#fff;font-size:11px;font-weight:700">‚úì</span>' : ''}
        </div>
        <div class="task-body" style="flex:1">
          <input class="task-edit-input" id="edit-input-${id}" type="text" value="${escapeHtml(task.text)}" maxlength="300">
          <div class="edit-tags-row" id="edit-tags-${id}" onclick="document.getElementById('edit-tag-input-${id}').focus()">
            <input type="text" class="tag-text-input" id="edit-tag-input-${id}" placeholder="Tag people by email‚Ä¶" style="min-width:140px;font-family:'DM Sans',sans-serif;color:var(--ink)">
          </div>
          <div class="edit-save-row">
            <button class="btn-save" onclick="saveEdit('${id}')">Save</button>
            <button class="btn-cancel" onclick="cancelEdit('${id}')">Cancel</button>
          </div>
        </div>
      </div>`;

    // Store editTags reference on element for saveEdit
    item._editTags = editTags;

    renderEditChips();

    const tagInput = document.getElementById(`edit-tag-input-${id}`);
    tagInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const v = tagInput.value.trim().replace(/,/g, '').toLowerCase();
        if (v && v.includes('@') && !editTags.includes(v)) { editTags.push(v); renderEditChips(); }
        tagInput.value = '';
      } else if (e.key === 'Backspace' && tagInput.value === '' && editTags.length) {
        editTags.pop(); renderEditChips();
      } else if (e.key === 'Escape') {
        cancelEdit(id);
      }
    });

    const editInput = document.getElementById(`edit-input-${id}`);
    editInput.focus();
    editInput.select();
    editInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') saveEdit(id);
      if (e.key === 'Escape') cancelEdit(id);
    });
  };

  window.saveEdit = async id => {
    const item = document.getElementById(`task-${id}`);
    const input = document.getElementById(`edit-input-${id}`);
    const text = input?.value.trim();
    if (!text) return;

    // Flush any uncommitted typed email
    const tagInput = document.getElementById(`edit-tag-input-${id}`);
    if (tagInput?.value.trim().includes('@')) {
      const v = tagInput.value.trim().toLowerCase();
      if (!item._editTags.includes(v)) item._editTags.push(v);
    }

    await updateDoc(doc(db, 'tasks', id), { text, tags: item._editTags || [], updatedAt: serverTimestamp() });
    // Firestore onSnapshot will re-render automatically
  };

  window.cancelEdit = id => {
    const task = cachedTasks.find(t => t.id === id);
    if (!task) return;
    document.getElementById(`task-${id}`).outerHTML = taskHTML(task);
  };

  // ‚îÄ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ
  window.addTask = async () => {
    const input = document.getElementById('new-task-input');
    const tagInput = document.getElementById('new-tag-input');
    if (tagInput.value.trim().includes('@')) { addNewTag(tagInput.value); tagInput.value = ''; }
    const text = input.value.trim();
    if (!text || !currentUser) return;
    input.value = '';
    const tags = [...newTaskTags];
    newTaskTags = []; renderNewTags();
    await addDoc(collection(db, 'tasks'), { uid: currentUser.uid, text, tags, done: false, createdAt: serverTimestamp() });
  };

  window.toggleTask = async (id, currentDone) => {
    await updateDoc(doc(db, 'tasks', id), { done: !currentDone });
  };

  window.deleteTask = async id => {
    if (!confirm('Delete this task?')) return;
    await deleteDoc(doc(db, 'tasks', id));
  };

  window.setFilter = (filter, btn) => {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTasks(cachedTasks);
  };

  document.getElementById('new-task-input').addEventListener('keydown', e => { if (e.key === 'Enter') window.addTask(); });
  document.getElementById('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') window.handleLogin(); });

  function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>
</body>
</html>
